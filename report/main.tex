\documentclass[]{mgr} % TODO change options at the end

\usepackage[T1]{fontenc}
%\usepackage{ae,aecompl} % TODO maybe this one looks better?
\usepackage{pslatex}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[nottoc,notlot,notlof]{tocbibind}
\usepackage{graphicx}
\usepackage{url}
\urlstyle{same} % line breaks in URLs
\usepackage[justification=centering]{caption}
\usepackage{amsthm}
\usepackage{mathtools}
% \usepackage[bookmarks=true, breaklinks]{hyperref} % TODO uncomment this and below 
% \usepackage[all]{hypcap} % needed to help hyperlinks direct correctly;
\usepackage{listings}
\usepackage[dvipsnames]{xcolor}
\usepackage{xargs}

% 1 - optional width
% 2 - filename
% 3 - caption in List of Figures and under picture
% 4 - optional caption after #3
\newcommandx{\includeimage}[4][1=1, 4=\empty]{
	\begin{figure}
		\centering
		\includegraphics[width=#1\textwidth]{img/#2}
		\caption[#3]{#3#4}
		\label{img:#2}
	\end{figure}
}

\lstset{
	tabsize=4,
	breaklines=true, 
	frame=single, 
	language=java,
	basicstyle=\small\ttfamily,
	breakatwhitespace=true,
	commentstyle=\color{OliveGreen},
	keywordstyle=\color{Black}
}

% TODO spell-checking!

\author{Michał Kowalski} % TODO inż.?
\supervisor{dr inż. Marek Woda} % TODO przecinek? jednostka?
\field{Informatyka (INF)}
\specialisation{Internet Engineering (INE)}
\title{Smartfon z systemem Android\\jako wysokopoziomowy sterownik robota}
\engtitle{Android smartphone\\as a high-level controller of a robot}

\begin{document}
\maketitle
\tableofcontents
\listoffigures

\chapter{Introduction}

\section{Description of problem}
Nowadays, popularity of robots is on the raise. It's not hard to built a simple
one, and Internet is full of tutorials how to build them. They are built
using specially programmed microcontrollers (MCUs), and simplest ones even
without any.
However, MCUs have some limitations:
\begin{enumerate}
  \item They have limited memory and computational capability.
  \item They require a lot of low-level configuration and programming.
  \item Each MCU model requires (at least) slightly different configuration.
  \item It's hard to look for help (e.g. on Stack Overflow,
  \cite{stack_overflow}) for specific MCU.
\end{enumerate}
Therefore, usage of Android smartphones as high-level controllers, sending
commands to MCU as low-level one, should be worth considering, because of:
\begin{enumerate}
  \item Lot of memory and powerful processors.
  \item Many built-in sensors.
  \item Many ways to communicate with surroundings, especially -
  with MCU.
  \item Popularity of Android platform:
  	\begin{itemize}
  	  \item tutorials,
  	  \item devices,
  	  \item solutions on Stack Overflow,
  	  \item external libraries.
  	\end{itemize}
  \item Compatibility between smartphones and Android versions.
  \item High-level programming and reduced low-level configuration.
\end{enumerate}

\section{Goal of a project}
Goal of this project is to check, if Android smartphone:
\begin{itemize}
  \item can communicate with microcontroller,
  \item can extend functionality of robots using its built-in sensors.
\end{itemize}
Found solutions should be analyzed with attention to:
\begin{itemize}
  \item compatibility,
  \item performance,
  \item difficulty of implementation.
\end{itemize}
Two Android smartphones (with different performance and Android version) will be
used: Sony Ericsson Xperia Neo and Motorola Moto G LTE. They will communicate
with MCU through USB cable, and face detection using built-in camera will be
used as an example of extending MCU's capabilities - it requires both computing
power and sensors not available in MCU, and there exists several ways to
implement this.

As MCU, a Freescale FRDM KL26Z will be used. \cite{mcu_on_eclipse} is a blog
dedicated to development on Freescale platform (mostly KL25Z, predecessor of
KL26Z), and even contains an article how to built a mobile robot on that
platform (img. \ref{img:frd_zumo}). It has articles how to use most of
those MCUs features, however from smartphone's point of view, only communication
using USB port (KL25Z and KL26Z have two of them) is required.

Because of already working solutions on Freescale's MCUs (described in
State-of-Art section), there is no need to build an actual, working robot - it's
proven, that those MCUs can be used as a controlling unit of a robot. Therefore,
this thesis focuses only on making use of smartphone for detecting position of
face (as in robot on img. \ref{img:SoA0}, but with Android instead of PC) and
sending text command to MCU (also as in \ref{img:SoA0}, but on Android, not PC).

\section{Content of thesis}
This thesis contains:
\begin{enumerate}
  \item Introduction - this chapter.
  \item Platforms - chapter describing MCU, Android, and used equipment.
  \item Communication - chapter about communication between smartphone and MCU.
  \item Sensors - chapter about extending robot's capabilities by using one of
  smartphone's sensors - camera.
  \item Summary - chapter with conclusions, whether Android smartphone can be
  used as high-level controller.
  \item Bibliography.
\end{enumerate}

\section{State of Art}
State of Art can be divided into three different areas:
\begin{enumerate}
  \item Robots working on Freescale's MCU.
  \item Robots controlled by mobile phones.
  \item ``Face Followers''.
\end{enumerate}

\subsection{Robots working on Freescale's MCU}
Good example of such robot can be Freedom Zumo Robot, described in one of posts
on \cite{mcu_on_eclipse} (img. \ref{img:frd_zumo}). It's built on FRDM KL25Z,
and Zumo Robot Kit for Arduino - KL25Z (and KL26Z probably too) is compatible with
it.
\includeimage{frd_zumo}{FRDM Zumo Robot, \cite{mcu_on_eclipse}}

Another example could be a robot built for one of previous projects - it will be
described later. Therefore, it's proven, that this MCU can be used for building
(at least simple) robots.

\subsection{Robots controlled by mobile phones}
Next category are robots controlled by mobile phones, like ones shown on fig.
\ref{img:SoA1}, \ref{img:SoA2} and \ref{img:SoA3}. It seems, that all of them
all remotely-controlled using another phone - clicking on button during phone
call with receiver generates a sound, which is received and transformed into
signal in headphones' port. None of examples have any (additional) logic in
phone. 

Some examples of robots controlled by additional program on smartphones
still exist, but most of them either are poorly documented, or are using
smartphone only as a remote, not part of the robot. 

The best example was line-following robot developed by co-students Krzysztof
Taborski and Kamil Szyc, but it wasn't published anywhere. Part of their code
was even used as one of methods to communicate between Android and MCU.

\includeimage{SoA1}{Mobile Controlled Robot by Ganeev Singh, \cite{SoA1}}
\includeimage{SoA2}{Mobile Controlled Robot by Robotics Bible, \cite{SoA2}}
\includeimage{SoA3}{Mobile Controlled Robot by Mayoogh Girish, \cite{SoA3}}

\subsection{``Face Followers''}
% TODO Face Followers

\includeimage{SoA0}{FaceFollower by Michał Kowalski and Adam Ćwik}

\chapter{Platforms}

\section{Android}
\includeimage{xperianeo}{Sony Ericsson Xperia Neo}
\includeimage{motog}{Motorola Moto G LTE}
\includeimage{androidstudio}{Android Studio}

\section{MCU}
\subsection{General info}
\includeimage{MCUs}{Freescale's FRDM KL25Z (left) and KL26Z (right)}
\includeimage{codewarrior}{CodeWarrior}

% TODO cdc/uart + message + \n

\subsection{Communication through UART}
\subsection{Communication through CDC}

\chapter{Communication}

\section{Introduction}
Three ways to communicate over USB were found:
\begin{itemize}
  \item USB Host API \cite{android_reference},
  \item usb-serial-for-android library by mik3y \cite{mik3y},
  \item UsbSerial by felHR85 \cite{felHR85}.
\end{itemize}
Because of similar names of projects, they will be referenced as Host API, mik3y
and felHR85.

% TODO all screenshots on xperia

\section{USB Host API}

\lstinputlisting[float, label=lst:usbhostapi, caption=USB Host API]
{code_samples/bulktransfer_sample.java}

\includeimage{comm/bulk/bulk_1}{USB Host API - sending 1 letter}
[\\Received text is correct. As it can be seen, in this test it takes about 22
ms to get an echo of each sent message. Although, during other (not documented
with screenshot) tests, sometimes (but less often) average duration was about 12
ms.]

\includeimage{comm/bulk/bulk_32}{USB Host API - sending 32 letters}
[\\Received text is correct. Average time of execution was 12 ms, but in other
tests, it also happened (but less often) to be 22 ms.]

\includeimage{comm/bulk/bulk_50}{USB Host API - sending 50 letters}
[\\Received text is correct. Average time of execution was 12 ms, but in
opposition to sending 1 or 32 letters, other values were not observed.]

\includeimage{comm/bulk/bulk_64}{USB Host API - sending 64 letters}
[\\Received text is NOT correct. Only first message is received completely, but
sent from MCU as two. Next ones are missing last character.]

\section{USB Serial by mik3y}

\lstinputlisting[float, label=lst:mik3y, caption=mik3y]
{code_samples/mik3y_sample.java}

\section{USB Serial by felHR85}

\subsection{Asynchronous mode}

\lstinputlisting[float, label=lst:async, caption=felHR85 async]
{code_samples/felhr85async_sample.java}

\includeimage{comm/async/async_cdc_1}{felHR85, async-cdc, 1 letter}
[]

\includeimage{comm/async/async_cdc_32}{felHR85, async-cdc, 32 letters}
[]

\includeimage{comm/async/async_cdc_50}{felHR85, async-cdc, 50 letters}
[]

\includeimage{comm/async/async_cdc_64}{felHR85, async-cdc, 64 letters}
[]

\includeimage{comm/async/async_cdc_70}{felHR85, async-cdc, 70 letters}
[]

\includeimage{comm/async/async_uart_1}{felHR85, async-uart, 1 letter}
[]

\includeimage{comm/async/async_uart_32}{felHR85, async-uart, 32 letters}
[]

\includeimage{comm/async/async_uart_50}{felHR85, async-uart, 50 letters}
[]

\includeimage{comm/async/async_uart_64}{felHR85, async-uart, 64 letters}
[]

\includeimage{comm/async/async_uart_70}{felHR85, async-uart, 70 letters}
[]

\clearpage

\subsection{Synchronous mode}

\lstinputlisting[float, label=lst:sync, caption=felHR85 sync]
{code_samples/felhr85sync_sample.java}

\includeimage{comm/sync/sync_cdc_1}{felHR85, sync-cdc, 1 letter}
[]

\includeimage{comm/sync/sync_cdc_32}{felHR85, sync-cdc, 32 letters}
[]

\includeimage{comm/sync/sync_cdc_50}{felHR85, sync-cdc, 50 letters}
[]

\includeimage{comm/sync/sync_cdc_64}{felHR85, sync-cdc, 64 letters}
[]

\includeimage{comm/sync/sync_uart_1}{felHR85, sync-uart, 1 letter}
[]

\includeimage{comm/sync/sync_uart_32}{felHR85, sync-uart, 32 letters (1)}
[]

\includeimage{comm/sync/sync_uart_32_2}{felHR85, sync-uart, 32 letters (2)}
[]

\includeimage{comm/sync/sync_uart_50}{felHR85, sync-uart, 50 letters (1)}
[]

\includeimage{comm/sync/sync_uart_50_2}{felHR85, sync-uart, 50 letters (2)}
[]

\includeimage{comm/sync/sync_uart_64}{felHR85, sync-uart, 64 letters}
[]

\includeimage{comm/sync/sync_uart_70}{felHR85, sync-uart, 70 letters (1)}
[]

\includeimage{comm/sync/sync_uart_70_2}{felHR85, sync-uart, 70 letters (2)}
[]

\clearpage

\subsection{Division of messages}

\includeimage{comm/div/div_async_cdc}{Division of message: async-cdc (1)}
[]

\includeimage{comm/div/div_async_cdc2}{Division of message: async-cdc (2)}
[]

\includeimage{comm/div/div_async_uart}{Division of message: async-uart}
[]

\includeimage{comm/div/div_sync_uart}{Division of message: sync-uart}
[]

% TODO sync-cdc?

\section{Summary}
% TODO tables with performance and pros/cons comparison

\chapter{Sensors}

\section{Introduction}
Modern smartphones have many sensors, and most of them can extend robot's
functionality. Sensors differ between phones, and new (or more advanced) ones can
be connected using possible connections (mostly USB and Bluetooth).
Most popular ones are:
\begin{itemize}
  \item touch screen,
  \item accelerometer,
  \item gyroscope,
  \item microphone(s),
  \item front and rear camera(s),
  \item position sensors:
  \begin{itemize}
    \item GPS,
    \item multilateration based on GSM and/or WiFi,
  \end{itemize}
  \item magnetometer,
  \item light sensor,
  \item proximity sensor.
\end{itemize}
Some (mostly high-end, or specialized ones) have also sensors like electronic
compass, humidity/temperature sensors, fingerprint scanner, or even thermal
camera.

% TODO write about face detecting
Available implementations of face detection includes:
\begin{itemize}
  \item FaceDetector API,
  \item Camera API,
  \item OpenCV for Android,
  \item OpenCV NDK.
\end{itemize}

% TODO short description

\section{FaceDetector API}
% hard to obtain bitmap from camera

% TODO screenshot + code sample
\lstinputlisting[float, label=lst:fdapi, caption=Face Detector API]
{code_samples/facedetectorapi_sample.java}

\includeimage[0.4]{facedetectorapi}{Face Detector API}

\section{Camera API}
% max 5 faces
% 30 ms in good light/on screen, 60 ms in bad
% resolution doesn't have impact on speed, only on quality
% detection in background

\lstinputlisting[float, label=lst:cameraapi, caption=Camera API]
{code_samples/cameraapi_sample.java}

\section{OpenCV for Android}
% detection in user's code

\lstinputlisting[float, label=lst:opencv, caption=OpenCV]
{code_samples/opencv_sample.java}

\includeimage{opencv_high}{openCV - high resolution}
\includeimage{opencv_low}{openCV - low resolution}

\section{OpenCV NDK}
% real time?
\includeimage{opencv_ndk}{openCV - NDK}

\section{Summary}
% TODO pros and cos of each method

\chapter{Summary}
% TODO summary of whole thesis

\begin{thebibliography}{9}
% TODO sort!

\bibitem{mcu_on_eclipse} 
Erich Styger, MCU on Eclipse,
\url{mcuoneclipse.com/},
29.04.2016

\bibitem{SoA1}
Ganeev Singh, Mobile Controlled Robot,\\
\url{engineersgarage.com/contribution/mobile-controlled-robot},
\date{29.05.2016}

\bibitem{SoA2}
Robotics Bible, Mobile Controlled Robot,\\
\url{roboticsbible.com/project-mobile-controlled-robot-without-microcontroller.html},\\
\date{29.05.2016}

\bibitem{SoA3}
Mayoogh Girish, Mobile Controlled Robot,\\
\url{diyhacking.com/mobile-controlled-robot},
\date{29.05.2016}

\bibitem{android_reference} 
Google Inc., Android Reference,
\url{developer.android.com}

\bibitem{opencv_reference} 
Itseez Inc., OpenCV Reference,
\url{http://opencv.org/}

\bibitem{stack_overflow} 
Stack Overflow,
\url{http://stackoverflow.com/}

\bibitem{mik3y} 
Mike Wakerly, usb-serial-for-android,\\
\url{github.com/mik3y/usb-serial-for-android},
20.05.2016

\bibitem{felHR85} 
Felipe Herranz, UsbSerial,
\url{github.com/felHR85/UsbSerial},
20.05.2016

\end{thebibliography}
\end{document}
